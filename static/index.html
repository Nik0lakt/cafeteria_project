<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</title>
    <style>
        body { margin: 0; font-family: -apple-system, sans-serif; background: #fcfcfc; display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column;}
        .card { background: #fff; width: 420px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.03); text-align: center; position: relative; }
        .amount { font-size: 48px; font-weight: 500; margin-bottom: 20px; }
        .video-box { width: 100%; height: 240px; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px; border: 1px solid #eee; }
        video { width: 100%; height: 100%; object-fit: cover; }
        input { width: 100%; padding: 15px; border: 1px solid #f0f0f0; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 16px; outline: none; }
        .btn { background: #007AFF; color: #fff; border: none; width: 100%; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-manual { background: none; border: none; color: #007AFF; font-size: 14px; cursor: pointer; margin-top: 15px; opacity: 0.7; }
        #comparison { display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        .photo-pair { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .photo-pair img, .photo-pair canvas { width: 140px; height: 140px; object-fit: cover; border-radius: 8px; border: 2px solid #eee; background: #f8f8f8; }
        .status-msg { font-size: 13px; color: #999; margin-top: 15px; white-space: pre-line; }
        .error-text { color: #dc3545; font-weight: bold; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
        .scanner-status { 
            font-size: 12px; margin-bottom: 10px; color: #dc3545; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .scanner-status.connected { color: #28a745; }
        .connect-btn { background: #6c757d; font-size: 12px; padding: 5px 10px; width: auto; margin-bottom: 15px; }
    </style>
</head>
<body>
    
    <div class="card">
        <div id="scannerControl">
            <div id="connectionStatus" class="scanner-status">üî¥ –°–∫–∞–Ω–µ—Ä –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>
            <button id="connectBtn" class="btn connect-btn" onclick="connectSerial()">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
        </div>

        <h1 id="userName" style="font-size: 18px; margin-bottom: 10px;">–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h1>
        <div class="amount" id="amountDisp">0 ‚ÇΩ</div>
        <div class="video-box"><video id="video" autoplay playsinline muted></video></div>
        
        <div id="mainUI">
            <input type="text" id="uidInput" placeholder="–ü—Ä–∏–ª–æ–∂–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID" autocomplete="off">
            <button class="btn" onclick="startProcess()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–∞—Ä—Ç—É</button>
            <button id="manualBtn" class="btn-manual" style="display:none" onclick="openManual()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
        </div>

        <div id="comparison">
            <div class="photo-pair">
                <div><img id="dbPhoto" alt="–ë–∞–∑–∞"></div>
                <div><canvas id="snapCanvas" width="140" height="140"></canvas></div>
            </div>
            <button class="btn" style="background:#34c759" onclick="finalize(true)">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –õ–ò–ß–ù–û–°–¢–¨</button>
        </div>
        <div id="status" class="status-msg">–û–∂–∏–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã...</div>
    </div>

    <script>
        const amount = new URLSearchParams(location.search).get('amount') || 0;
        document.getElementById('amountDisp').innerText = amount + " ‚ÇΩ";
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        let currentSid = null;
        let currentUid = null;

        navigator.mediaDevices.getUserMedia({video:true}).then(s => video.srcObject = s);

        // --- –õ–û–ì–ò–ö–ê WEB SERIAL API (–°–ö–ê–ù–ï–†) ---
        let port;
        let reader;
        let keepReading = false;

        // –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–µ—Å–ª–∏ —É–∂–µ –¥–∞–≤–∞–ª–∏ –¥–æ—Å—Ç—É–ø)
        document.addEventListener('DOMContentLoaded', async () => {
            if ("serial" in navigator) {
                const ports = await navigator.serial.getPorts();
                if (ports.length > 0) {
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ø–µ—Ä–≤–æ–º—É –∏–∑–≤–µ—Å—Ç–Ω–æ–º—É –ø–æ—Ä—Ç—É
                    connectToPort(ports[0]);
                }
            }
        });

        async function connectSerial() {
            if (!("serial" in navigator)) {
                alert("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Serial API (–Ω—É–∂–µ–Ω Chrome/Yandex)");
                return;
            }
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ—Ä—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const p = await navigator.serial.requestPort();
                connectToPort(p);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ—Ä—Ç–∞:", err);
            }
        }

        async function connectToPort(p) {
            try {
                port = p;
                await port.open({ baudRate: 9600 }); // –°–∫–æ—Ä–æ—Å—Ç—å –∫–∞–∫ –≤ Arduino

                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('connectionStatus').innerText = "üü¢ –°–∫–∞–Ω–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω";
                document.getElementById('connectionStatus').classList.add('connected');
                document.getElementById('connectBtn').style.display = 'none';

                keepReading = true;
                readSerialLoop();
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ—Ä—Ç–∞:", err);
                // –ï—Å–ª–∏ –∞–≤—Ç–æ-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                document.getElementById('connectionStatus').innerText = "üî¥ –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
                document.getElementById('connectBtn').style.display = 'inline-block';
            }
        }

        async function readSerialLoop() {
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            let buffer = "";

            try {
                while (keepReading) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        buffer += value;
                        // –ò—â–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ (–ø—Ä–∏–∑–Ω–∞–∫ –∫–æ–Ω—Ü–∞ UID –æ—Ç Arduino)
                        if (buffer.includes('\n')) {
                            const lines = buffer.split('\n');
                            // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –ø–æ–ª–Ω—É—é –∫–æ–º–∞–Ω–¥—É
                            for (let i = 0; i < lines.length - 1; i++) {
                                const scannedUid = lines[i].trim().toUpperCase();
                                if (scannedUid.length > 0) {
                                    handleScan(scannedUid);
                                }
                            }
                            buffer = lines[lines.length - 1]; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö–≤–æ—Å—Ç
                        }
                    }
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è:", error);
                document.getElementById('connectionStatus').innerText = "üî¥ –†–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
                document.getElementById('connectionStatus').classList.remove('connected');
                document.getElementById('connectBtn').style.display = 'inline-block';
            } finally {
                reader.releaseLock();
            }
        }

        function handleScan(uid) {
            console.log("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:", uid);
            // 1. –í—Å—Ç–∞–≤–ª—è–µ–º UID –≤ –ø–æ–ª–µ
            const input = document.getElementById('uidInput');
            input.value = uid;
            
            // 2. –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
            input.style.backgroundColor = "#e8f0fe";
            setTimeout(() => input.style.backgroundColor = "#fff", 300);

            // 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å (–∫–∞–∫ –±—É–¥—Ç–æ –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É)
            startProcess();
        }

        // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---

        async function startProcess() {
            currentUid = document.getElementById('uidInput').value.trim();
            if(!currentUid) return;
            
            status.innerText = "–ü–æ–∏—Å–∫ –∫–∞—Ä—Ç—ã...";
            
            try {
                const res = await fetch(`/api/employee_info?card_uid=${currentUid}`);
                if(!res.ok) {
                    status.innerText = "–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞";
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    document.getElementById('uidInput').value = '';
                    return;
                }
                
                const user = await res.json();
                document.getElementById('userName').innerText = user.name;
                
                const sRes = await fetch(`/api/start_liveness?card_uid=${currentUid}`, {method:'POST'});
                const sData = await sRes.json();
                currentSid = sData.session_id;
                
                document.getElementById('manualBtn').style.display = 'inline-block';
                status.innerText = "–°–º–æ—Ç—Ä–∏—Ç–µ –≤ –∫–∞–º–µ—Ä—É...";
                runLiveness();
            } catch (e) {
                status.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
                console.error(e);
            }
        }

        async function runLiveness() {
            if(!currentSid) return;
            const canvas = document.createElement('canvas');
            canvas.width = 640; canvas.height = 480;
            canvas.getContext('2d').drawImage(video, 0, 0);
            canvas.toBlob(async (blob) => {
                try {
                    const fd = new FormData(); fd.append('session_id', currentSid); fd.append('file', blob);
                    const r = await fetch('/api/liveness_frame', {method:'POST', body:fd});
                    const d = await r.json();
                    
                    if(d.status === 'finished') {
                        finalize(false);
                    } else if(currentSid) {
                        setTimeout(runLiveness, 600);
                    }
                } catch (e) {
                    console.log("Liveness error/retry");
                    if(currentSid) setTimeout(runLiveness, 600);
                }
            }, 'image/jpeg');
        }

        function openManual() {
            document.getElementById('mainUI').style.display = 'none';
            document.getElementById('comparison').style.display = 'block';
            document.getElementById('dbPhoto').src = `static/photos/${currentUid}.jpg?t=${new Date().getTime()}`;
            const ctx = document.getElementById('snapCanvas').getContext('2d');
            ctx.drawImage(video, 0, 0, 640, 480, 0, 0, 140, 140);
        }

        async function finalize(isManual) {
            status.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∏ –æ–ø–ª–∞—Ç–∞...";
            let livePhoto = isManual ? document.getElementById('snapCanvas').toDataURL('image/jpeg', 0.8) : null;
            
            try {
                const res = await fetch('/api/pay', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        session_id: currentSid, 
                        amount_rub: parseInt(amount), 
                        items: JSON.parse(localStorage.getItem('cart') || '[]'),
                        is_manual: isManual,
                        live_frame_base64: livePhoto 
                    })
                });

                const data = await res.json();
                if(res.ok) { 
                    status.innerText = "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!";
                    localStorage.removeItem('cart'); 
                    currentSid = null;
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º, —á—Ç–æ–±—ã –∫–∞—Å—Å–∏—Ä —É–≤–∏–¥–µ–ª —É—Å–ø–µ—Ö
                    setTimeout(() => { location.href = 'canteen.html'; }, 1500);
                } else {
                    status.innerHTML = `<span class="error-text">–û–¢–ö–ê–ó: ${data.detail}</span>`;
                    currentSid = null;
                    document.getElementById('manualBtn').style.display = 'none';
                    // –ï—Å–ª–∏ –æ—Ç–∫–∞–∑, –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç—ã
                    document.getElementById('uidInput').value = '';
                }
            } catch (e) {
                status.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞";
            }
        }
    </script>
</body>
</html>
